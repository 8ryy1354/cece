<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŠå¤©å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤</h1>

    <!-- æ³¨å†Œè¡¨å• -->
    <div id="register-form" class="max-w-md mx-auto bg-white shadow rounded p-4">
      <h2 class="text-xl font-semibold mb-2">æ³¨å†Œ</h2>
      <div class="mb-2">
        <input type="text" id="register-username" placeholder="ç”¨æˆ·å" class="w-full p-2 border rounded">
      </div>
      <div class="mb-2">
        <input type="password" id="register-password" placeholder="å¯†ç " class="w-full p-2 border rounded">
      </div>
      <button onclick="registerUser()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">æ³¨å†Œ</button>
      <p class="text-sm mt-2">å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showLogin()" class="text-blue-500 underline">å»ç™»å½•</a></p>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <div id="login-form" class="max-w-md mx-auto bg-white shadow rounded p-4 hidden">
      <h2 class="text-xl font-semibold mb-2">ç™»å½•</h2>
      <div class="mb-2">
        <input type="text" id="login-username" placeholder="ç”¨æˆ·å" class="w-full p-2 border rounded">
      </div>
      <div class="mb-2">
        <input type="password" id="login-password" placeholder="å¯†ç " class="w-full p-2 border rounded">
      </div>
      <button onclick="loginUser()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">ç™»å½•</button>
      <p class="text-sm mt-2">æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="showRegister()" class="text-green-600 underline">å»æ³¨å†Œ</a></p>
    </div>

    <!-- ç™»å½•æˆåŠŸåçš„ç”¨æˆ·ä¿¡æ¯ -->
    <div id="user-info" class="max-w-2xl mx-auto bg-white shadow rounded p-4 hidden">
      <h2 class="text-xl font-semibold">æ¬¢è¿ï¼Œ<span id="username-display"></span>ï¼ˆID: <span id="user-id-display"></span>ï¼‰</h2>
      <button onclick="logoutUser()" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded">é€€å‡ºç™»å½•</button>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div id="chat" class="max-w-2xl mx-auto bg-white shadow rounded p-4 mt-6 hidden flex flex-col space-y-4">
      <h2 class="text-xl font-semibold">èŠå¤©</h2>

      <!-- æ¥æ”¶è€… ID -->
      <div>
        <input type="text" id="partner-id" placeholder="æ¥æ”¶è€… IDï¼ˆå¯ç‚¹å‡»èŠå¤©å¯¹è±¡è‡ªåŠ¨å¡«å†™ï¼‰" class="w-full p-2 border rounded">
      </div>

      <!-- æ¶ˆæ¯å®¹å™¨ -->
      <div id="messages" class="flex flex-col max-h-[300px] overflow-y-auto p-2 border rounded bg-gray-50 space-y-2"></div>

      <!-- èŠå¤©è¾“å…¥ -->
      <div>
        <textarea id="message" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" rows="3" class="w-full p-2 border rounded resize-none"></textarea>
        <button onclick="sendMessage()" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">å‘é€</button>
      </div>
    </div>

    <!-- èŠå¤©å¯¹è±¡åŒºåŸŸï¼ˆç‹¬ç«‹ï¼‰ -->
    <div id="chat-partners" class="max-w-2xl mx-auto bg-white shadow rounded p-4 mt-6 hidden">
      <h2 class="text-xl font-semibold mb-2">èŠå¤©å¯¹è±¡</h2>
      <div class="mb-2 flex gap-2">
        <input type="text" id="add-partner-id" placeholder="è¾“å…¥ç”¨æˆ· ID æ·»åŠ èŠå¤©å¯¹è±¡" class="flex-1 p-2 border rounded">
        <button onclick="addChatPartner()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">æ·»åŠ </button>
      </div>
      <ul id="partner-list" class="space-y-2"></ul>
    </div>
  </div>

  <script>
  let currentChatTarget = null; // å½“å‰èŠå¤©å¯¹è±¡
window.unreadCounts = {}; // ç”¨äºè®°å½•æ¯ä¸ªèŠå¤©å¯¹è±¡çš„æœªè¯»æ¶ˆæ¯æ•°
   const apiUrl = 'https://cece.8ryingye.workers.dev';
    
    async function registerUser() {
      const username = document.getElementById('register-username').value;
      const password = document.getElementById('register-password').value;

      const response = await fetch(`${apiUrl}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      const result = await response.json();
      if (result.success) {
        alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
        showLogin();
      } else {
        alert(result.message);
      }
    }

    function showLogin() {
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
    }

    function showRegister() {
      document.getElementById('register-form').style.display = 'block';
      document.getElementById('login-form').style.display = 'none';
    }

async function loginUser() {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;

  const response = await fetch(`${apiUrl}/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });

  const result = await response.json();

  if (result.success) {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('user-info').style.display = 'block';
    document.getElementById('chat').style.display = 'block';
    document.getElementById('chat-partners').style.display = 'block';

    document.getElementById('username-display').textContent = result.username;
    document.getElementById('user-id-display').textContent = result.userId;

    localStorage.setItem('userId', result.userId);
    localStorage.setItem('username', result.username);

    // âœ… è·å–æ‰€æœ‰ç”¨æˆ·
    window.userMap = {};
    const userRes = await fetch(`${apiUrl}/get-users`, { method: 'POST' });
    const userData = await userRes.json();
    if (userData.success && Array.isArray(userData.users)) {
      userData.users.forEach(user => {
        window.userMap[user.userId] = user.username;
      });
    }

    // âœ… åŠ è½½èŠå¤©å¯¹è±¡åˆ—è¡¨
    loadChatPartners();

    // âœ… æ¯ 3 ç§’åˆ·æ–°èŠå¤©è®°å½•ï¼ˆå½“å‰èŠå¤©å¯¹è±¡ï¼‰
    setInterval(() => {
      if (currentChatTarget) {
        loadMessages();
      }
    }, 3000);

    // âœ… æ¯ 3 ç§’åˆ·æ–°æœªè¯»æ¶ˆæ¯
    setInterval(() => {
      const userId = localStorage.getItem('userId');
      if (userId) {
        loadUnreadCounts();
      }
    }, 3000);

  } else {
    alert(result.message);
  }
}


async function loadUnreadCounts() {
  const userId = localStorage.getItem('userId');
  console.log("[ğŸ”] æ­£åœ¨æ£€æŸ¥æœªè¯»æ¶ˆæ¯... ç”¨æˆ·ID:", userId);

  if (!userId) return;

  const response = await fetch(`${apiUrl}/get-unread`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId })
  });

  const result = await response.json();
  console.log("[ğŸ“¥] åç«¯è¿”å›æœªè¯»æ¶ˆæ¯æ•°æ®:", result);

  if (result.success) {
    window.unreadCounts = result.unread || {};
    console.log("[ğŸ“Š] æ›´æ–° window.unreadCounts ä¸º:", window.unreadCounts);
    updatePartnerListUI(); // âœ… è°ƒç”¨ UI æ›´æ–°å‡½æ•°
  }
}


    function logoutUser() {
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      document.getElementById('user-info').style.display = 'none';
      document.getElementById('chat').style.display = 'none';
      document.getElementById('chat-partners').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
    }

    async function sendMessage() {
      const from = localStorage.getItem('userId'); // âœ… å‘é€è€…IDå¿…é¡»æ˜¯userId
      const to = document.getElementById('partner-id').value || 'å®¢æœ';
      const text = document.getElementById('message').value;

      const response = await fetch(`${apiUrl}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from, to, type: 'text', text })
      });

const result = await response.json();
if (result.ok) {
  alert('æ¶ˆæ¯å‘é€æˆåŠŸ');
  document.getElementById('message').value = '';
  loadMessages(); // âœ… æ·»åŠ è¿™ä¸€è¡Œï¼Œåˆ·æ–°èŠå¤©è®°å½•
} else {
  alert('æ¶ˆæ¯å‘é€å¤±è´¥');
}
}

async function loadMessages() {
  const userId = localStorage.getItem('userId');
  const partnerId = currentChatTarget || document.getElementById('partner-id').value;

  if (!userId || !partnerId) {
    console.error("ç”¨æˆ·IDæˆ–èŠå¤©å¯¹è±¡IDä¸ºç©º");
    return;
  }

  const response = await fetch(`${apiUrl}/get-messages`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, partnerId })
  });

  const result = await response.json();
  const container = document.getElementById('messages');
  container.innerHTML = '';

  if (result.success && Array.isArray(result.messages)) {
    const username = localStorage.getItem('username');

    result.messages.forEach(message => {
      const isMe = message.from.trim() === username.trim();
      const div = document.createElement('div');
      div.className = 'message';
      div.style.textAlign = isMe ? 'right' : 'left';
      div.innerHTML = `
        <strong>${message.from}</strong>
        <small style="color:gray;">${formatTime(message.timestamp)}</small><br>
        ${formatMessage(message)}
      `;
      container.appendChild(div);
    });
  } else {
    container.innerHTML = '<p>æš‚æ— æ¶ˆæ¯</p>';
  }
    // âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  container.scrollTop = container.scrollHeight;
}

// âœ… å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´æˆ³
function formatTime(ts) {
  if (!ts) return '';
  const date = new Date(ts);
  return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
}

// âœ… å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ¶ˆæ¯
function formatMessage(msg) {
  if (msg.type === 'photo') {
    return `<img src="${msg.url}" style="max-width: 200px;">`;
  } else if (msg.type === 'video') {
    return `<video src="${msg.url}" controls style="max-width: 200px;"></video>`;
  } else if (msg.type === 'file') {
    return `<a href="${msg.url}" target="_blank">ä¸‹è½½æ–‡ä»¶</a>`;
  } else {
    return msg.text;
  }
      // âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  container.scrollTop = container.scrollHeight;
}





// æ·»åŠ èŠå¤©å¯¹è±¡
async function addChatPartner() {
  const userId = localStorage.getItem('userId');
  const targetId = document.getElementById('add-partner-id').value;

  const response = await fetch(`${apiUrl}/add-chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, targetId }),
  });

  const result = await response.json();
  if (result.success) {
    alert('æ·»åŠ æˆåŠŸ');
    loadChatPartners();
  } else {
    alert('æ·»åŠ å¤±è´¥ï¼š' + result.message);
  }
}

async function loadChatPartners() {
  const userId = localStorage.getItem('userId');

  const response = await fetch(`${apiUrl}/get-chats`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId })
  });

  const result = await response.json();

  if (result.success && Array.isArray(result.list)) {
    window.chatPartnerList = result.list; // âœ… ä¿å­˜èŠå¤©å¯¹è±¡ ID
    updatePartnerListUI(); // âœ… æ¸²æŸ“åˆ—è¡¨
  } else {
    alert(result.message || 'è·å–èŠå¤©å¯¹è±¡å¤±è´¥');
  }
}

async function deleteChatPartner(partnerId) {
  const userId = localStorage.getItem('userId');
  const response = await fetch(`${apiUrl}/delete-chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, targetId: partnerId })
  });

  const result = await response.json();
  if (result.success) {
    alert('åˆ é™¤æˆåŠŸ');
    loadChatPartners();
  } else {
    alert(result.message || 'åˆ é™¤å¤±è´¥');
  }
}
function updatePartnerListUI() {
  console.log("[ğŸ–Œ] æ­£åœ¨åˆ·æ–°èŠå¤©å¯¹è±¡åˆ—è¡¨...");

  const list = document.getElementById('partner-list');
  list.innerHTML = '';

  const userMap = window.userMap || {};
  const unread = window.unreadCounts || {};
  const partnerIds = window.chatPartnerList || [];

  partnerIds.forEach(partnerId => {
    const username = userMap[partnerId] || 'æœªçŸ¥ç”¨æˆ·';
    const count = unread[partnerId] || 0;

    console.log(`[ğŸ”„] æ¸²æŸ“èŠå¤©å¯¹è±¡: ${partnerId}ï¼ˆ${username}ï¼‰ æœªè¯»æ•°: ${count}`);

    const li = document.createElement('li');
    li.className = 'flex items-center justify-between';

    const label = document.createElement('span');
    label.innerHTML = `${username} (ID: ${partnerId})`;

    // ğŸ”´ çº¢ç‚¹æé†’
    if (count > 0) {
      const dot = document.createElement('span');
      dot.className = 'inline-block w-2 h-2 bg-red-500 rounded-full ml-2';
      label.appendChild(dot);
    }

    const chatBtn = document.createElement('button');
    chatBtn.textContent = 'èŠå¤©';
    chatBtn.className = 'ml-2 text-blue-600';
    chatBtn.onclick = () => {
      document.getElementById('partner-id').value = partnerId;
      currentChatTarget = partnerId;
      window.unreadCounts[partnerId] = 0; // æ¸…é™¤æœªè¯»
      loadMessages();
    };

    const delBtn = document.createElement('button');
    delBtn.textContent = 'åˆ é™¤';
    delBtn.className = 'ml-2 text-red-600';
    delBtn.onclick = () => deleteChatPartner(partnerId);

    li.appendChild(label);
    li.appendChild(chatBtn);
    li.appendChild(delBtn);
    list.appendChild(li);
  });
}


  </script>
</body>
</html>
