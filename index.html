<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天系统</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chat-box { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .input-box { width: 100%; padding: 10px; margin-bottom: 10px; }
        .message { padding: 8px; margin: 5px 0; border-radius: 5px; }
        .user-message { background-color: #e0f7fa; }
        .bot-message { background-color: #ffecb3; }
        .file-preview { max-width: 200px; max-height: 200px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>欢迎来到聊天系统</h1>
    <div class="chat-box" id="chat-box"></div>

    <textarea id="message" class="input-box" placeholder="输入消息..."></textarea>
    <input type="file" id="fileInput" />
    <button onclick="sendMessage()">发送</button>

    <script>
        async function sendMessage() {
            const message = document.getElementById("message").value;
            const fileInput = document.getElementById("fileInput");
            const chatBox = document.getElementById("chat-box");

            // 先清空输入框
            document.getElementById("message").value = '';
            fileInput.value = '';

            // 显示消息
            if (message) {
                chatBox.innerHTML += `<div class="message user-message">${message}</div>`;
            }

            // 上传文件（如果有文件）
            let fileUrl = '';
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append("reqtype", "fileupload");
                formData.append("fileToUpload", file);

                const uploadRes = await fetch("https://catbox.moe/user/api.php", {
                    method: "POST",
                    body: formData,
                });

                fileUrl = await uploadRes.text();
                if (file.type.startsWith("image")) {
                    chatBox.innerHTML += `<div class="message user-message"><img src="${fileUrl}" class="file-preview" /></div>`;
                } else if (file.type.startsWith("video")) {
                    chatBox.innerHTML += `<div class="message user-message"><video controls class="file-preview"><source src="${fileUrl}" type="${file.type}"></video></div>`;
                }
            }

            // 发送到 Worker
            const data = {
                from: "用户", // 这里可以替换成用户的名字
                to: "客服",
                type: message ? "text" : file.type.startsWith("image") ? "photo" : "video",
                text: message || '',
                url: fileUrl,
            };

            await fetch("https://cece.8ryingye.workers.dev/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            // 显示客服消息（模拟回复）
            setTimeout(() => {
                chatBox.innerHTML += `<div class="message bot-message">客服：我已收到你的消息</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 500);
        }
    </script>
</body>
</html>
